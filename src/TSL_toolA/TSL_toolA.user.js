// ==UserScript==
// @name         Taiwan SportsLottery 綜合腳本
// @namespace    https://github.com/jjj9458
// @version      1.0
// @description  v1.0：MyBets 自動計算 + 隱藏功能
// @author       jjj9458
// @match        https://member.sportslottery.com.tw/*
// @match        https://www-talo-ssb-pr.sportslottery.com.tw/*
// @run-at       document-end
// @grant        none
// @license      GPL-3.0
// @updateURL    https://raw.githubusercontent.com/jjj9458/TampermonkeyUserscripts/main/src/TSL_toolA/TSL_toolA.user.js
// @downloadURL  https://raw.githubusercontent.com/jjj9458/TampermonkeyUserscripts/main/src/TSL_toolA/TSL_toolA.user.js
// @homepageURL  https://github.com/jjj9458/TampermonkeyUserscripts
// @supportURL   https://github.com/jjj9458/TampermonkeyUserscripts/issues
// ==/UserScript==
(function(){'use strict';(function(){const e=t=>function(){const n=t.apply(this,arguments);return window.dispatchEvent(new Event('locationchange')),n};history.pushState=e(history.pushState),history.replaceState=e(history.replaceState),window.addEventListener('popstate',()=>window.dispatchEvent(new Event('locationchange')));})();if(location.host==='member.sportslottery.com.tw'){let e=null,t=parseInt(localStorage.getItem('KeepAliveStartTs'),10)||null,n=!1;const o=3.5*3600*1e3,r=window.fetch;window.fetch=function(i,a){if(typeof i==='string'&&i.includes('/session-manager/v2/session/heartBeat'))try{const s=a&&a.body,c=s&&JSON.parse(s).sessionToken,l=e&&JSON.parse(e.body).sessionToken;(!e||c!==l)&&(e=a,t=Date.now(),localStorage.setItem('KeepAliveStartTs',t),n=!1);else e=a}catch{}return r(i,a)};async function i(){if(!e)return;try{const t=await r('https://member.sportslottery.com.tw/session-manager/v2/session/heartBeat',e);await t.json()}catch{}}window.sendHeartbeat=i;!function s(){const e=240000,t=Math.floor(Math.random()*31),n=1e3*t,o=t%2===0?e+n:e-n;setTimeout(async()=>{await i(),s()},o)}(),setInterval(()=>{t&&!n&&Date.now()-t>=o&&(n=!0,alert('⚠️ Session 已超過 3.5 小時，請重新登入！'))},6e4)}function a(){const e=location.host;if(!((e==='member.sportslottery.com.tw'&&location.pathname.startsWith('/account/my-bets'))||e==='www-talo-ssb-pr.sportslottery.com.tw'))return;const t=window.top===window.self;function n(){if(document.querySelector('#myCalcButton'))return;const e=document.querySelector('.styled__BreadcrumbsInfo-sc-1ipvy8g-6');if(!e)return;e.style.display='flex',e.style.justifyContent='space-between',e.style.gap='1rem';const t=document.createElement('div');t.style.display='inline-flex',t.style.alignItems='center',t.style.gap='0.5rem';const n=document.createElement('span');n.textContent='先到已派彩，設定日期區間，再按';const o=document.createElement('button');o.id='myCalcButton',o.textContent='計算';const r=document.createElement('span');r.id='myCalcText',t.append(n,o,r),e.appendChild(t);let i=0,a=0,s=0;window.addEventListener('message',e=>{e.origin==='https://www-talo-ssb-pr.sportslottery.com.tw'&&e.data?.type==='BET_RESULTS'&&(a+=e.data.totalStake,s+=e.data.totalReturn,i--,i===0&&(r.textContent=`共花費：${a}，共中獎：${s}，淨利：${s-a}`,o.disabled=!1))}),o.addEventListener('click',()=>{r.textContent='計算中...',o.disabled=!0,a=0,s=0;const e=Array.from(document.querySelectorAll('iframe[src*="talo-ssb-pr"]'));if(i=e.length,i===0)return r.textContent='找不到 iframe',o.disabled=!1,void 0;e.forEach(t=>t.contentWindow.postMessage({type:'START_CALC'},'https://www-talo-ssb-pr.sportslottery.com.tw'))})}function o(){const e=setInterval(()=>{n(),document.querySelector('#myCalcButton')&&clearInterval(e)},300)}function r(){window.addEventListener('message',e=>{if(e.origin==='https://member.sportslottery.com.tw'&&e.data?.type==='START_CALC'){let t=0,n=document,o=setInterval(()=>{let r=n.querySelector('.MyBetsstyled__LoadMoreButton-sc-nwucds-1')||Array.from(n.querySelectorAll('button')).find(e=>/載入更多|更多|Load\s?More/i.test(e.innerText));if(r)r.click(),t=0;else if(++t>=3){clearInterval(o);let t=0,r=0;n.querySelectorAll('[data-test-id="amount-mybets-mgs-totalstake"]').forEach(e=>{const n=e.closest('[title]')?.title||e.innerText;t+=parseFloat(n.replace(/[^\d\.-]/g,''))||0}),n.querySelectorAll('[data-test-id="amount-mybets-mgs-potentialreturn"]').forEach(e=>{const n=e.closest('[title]')?.title||e.innerText;r+=parseFloat(n.replace(/[^\d\.-]/g,''))||0}),window.parent.postMessage({type:'BET_RESULTS',totalStake:t,totalReturn:r},'https://member.sportslottery.com.tw')}})},500)}}t?o():r()}window.addEventListener('load',a),window.addEventListener('locationchange',a)})();
